<div class="messages-container" #chatContent (scroll)="onScroll($event)" *ngIf="messages.length > 0">
  <div class="message-group" *ngFor="let group of messageGroups">
    <div class="date-divider">
      <div class="line"></div>
      <span class="date-label">{{ group.date }}</span>
      <div class="line"></div>
    </div>

    <div *ngFor="let message of group.messages" class="message" [class.guest]="isCurrentUser(message.userId)"
      (mouseover)="showReactionOptions($event, message)" (mouseleave)="hideReactionOptions($event, message)">
      <div class="avatar-container" *ngIf="message.avatar">
        <img [src]="'assets/img/avatars/' + message.avatar" [alt]="message.username + ' avatar'" class="user-avatar">
      </div>
      <div class="message-content">
        <div class="message-header">
          <span class="username">{{ message.username }}</span>
          <span class="timestamp">{{ message.timestamp | date:'HH:mm' }} Uhr</span>
        </div>
        <div class="message-text">
          <!-- Normaler Text oder Edit-Modus -->
          <div *ngIf="!message.isEditing" class="message-text">
            {{ message.text }}
          </div>

          <!-- Edit-Modus -->
          <div *ngIf="message.isEditing" class="message-edit-container">
            <input type="text" [(ngModel)]="message.editText" class="message-edit-input"
              (keyup.enter)="saveEditedMessage(message)" (keyup.escape)="cancelEdit(message)">

            <div class="edit-actions">
              <button class="edit-button cancel" (click)="cancelEdit(message)">
                Abbrechen
              </button>
              <button class="edit-button save" (click)="saveEditedMessage(message)">
                Speichern
              </button>
            </div>
          </div>

          <!-- Reaktions-Optionen -->
          <div class="reaction-options" [class.show]="message.showReactions">
            <div class="quick-reactions">
              <div class="reaction-emoji" (click)="addReaction(message, 'üëç')">üëç</div>
              <div class="reaction-emoji" (click)="addReaction(message, '‚ù§Ô∏è')">‚ù§Ô∏è</div>
              <div class="reaction-emoji" (click)="addReaction(message, 'üòÇ')">üòÇ</div>
              <div class="reaction-emoji picker-trigger" (click)="showEmojiPickerForMessage($event, message)">
                <mat-icon>add_reaction</mat-icon>
              </div>
              <div class="reaction-emoji picker-trigger" *ngIf="isCurrentUser(message.userId)"
                (click)="toggleEditMenu($event, message)">
                <mat-icon>more_vert</mat-icon>
              </div>
              <div class="reaction-emoji picker-trigger" *ngIf="!isDirectMessage && !isCurrentUser(message.userId)"
                (click)="openThread($event, message)">
                <mat-icon>comment</mat-icon>
              </div>
            </div>
          </div>

          <!-- Emoji Picker -->
          <div class="message-emoji-picker" *ngIf="message.showEmojiPicker">
            <div class="emoji-container">
              <div class="emoji" *ngFor="let emoji of emojis" (click)="addReaction(message, emoji)">
                {{ emoji }}
              </div>
            </div>
          </div>

        </div>

        <!-- Angezeigte Reaktionen unter der Nachricht -->
        <div class="badge-container">
          <div class="message-reactions" *ngIf="message.reactions && message.reactions.length > 0">
            <div class="reaction-wrapper" *ngFor="let reaction of groupReactions(message.reactions)">
              <!-- Tooltip f√ºr jede einzelne Reaktion -->
              <div *ngIf="tooltipVisibility[message.id + '-' + reaction.emoji]" class="reaction-tooltip">
                <div class="tooltip-content">
                  <div class="emoji-preview">{{ reaction.emoji }}</div>
                  <div class="users-list">
                    <div class="user-item" *ngFor="let userId of reaction.users">
                      <span class="username">{{ getUserName(userId) }}</span>
                      <span class="reaction-text">hat reagiert</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="reaction-badge" [class.user-reacted]="hasUserReacted(message, reaction.emoji)"
                [attr.data-emoji]="reaction.emoji" (mouseover)="handleReactionHover($event, message, reaction)"
                (mouseleave)="handleReactionLeave($event, message, reaction)">
                <span class="reaction-emoji">{{ reaction.emoji }}</span>
                <span class="reaction-count">{{ reaction.count }}</span>
              </div>
            </div>
          </div>

          <!-- Neue Thread-Replies Anzeige -->
          <div class="thread-replies-badge" *ngIf="!isDirectMessage && getThreadRepliesCount(message.id) > 0"
            (click)="openThread($event, message)">
            <span class="replies-count">{{ getThreadRepliesCount(message.id) }}</span>
            <span *ngIf="getThreadRepliesCount(message.id) === 1">Antwort</span>
            <span *ngIf="getThreadRepliesCount(message.id) > 1">Antworten</span>
          </div>
        </div>

        <!-- Edit Menu - Jetzt innerhalb der message-Schleife -->
        <div class="edit-menu" *ngIf="message.showEditMenu">
          <div class="edit-option" (click)="startEditingMessage(message)">
            <mat-icon>edit</mat-icon>
            <span>Nachricht bearbeiten</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>